<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Edit Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
body{font-family:system-ui;background:#f1f5f9;padding:15px}
input,textarea,button{width:100%;padding:10px;margin:6px 0}
button{background:#2563eb;color:white;border:none;border-radius:8px}
h2{text-align:center}
.card{background:white;padding:15px;border-radius:12px}
</style>
</head>

<body>

<h2>Edit Digital Card</h2>

<div class="card">
<input id="name" placeholder="Full Name">
<input id="businessName" placeholder="Business Name">
<textarea id="businessInfo" placeholder="Business Info"></textarea>
<input id="address" placeholder="Address">
<input id="phone" placeholder="Phone">
<input id="email" placeholder="Email">
<input id="facebook" placeholder="Facebook">
<input id="instagram" placeholder="Instagram">
<input id="youtube" placeholder="YouTube">

<label>Change Profile Image</label>
<input type="file" id="profileImage">

<h3>Offers</h3>
<div id="offers"></div>
<button onclick="addOffer()">Add Offer</button>

<br><br>
<button onclick="save()">Save Changes</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const supabase = supabase.createClient(
 'https://dfvnefbxgayxqgjjgtrr.supabase.co',
 'sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE'
);

const id=new URLSearchParams(location.search).get("id");
if(!id) location="index.html";

let originalData=null;

load();

async function load(){
 const {data}=await supabase
  .from("cards")
  .select()
  .eq("id",id)
  .single();

 originalData=JSON.parse(data.data);

 name.value=originalData.name;
 businessName.value=originalData.businessName;
 businessInfo.value=originalData.businessInfo;
 address.value=originalData.address;
 phone.value=originalData.phone;
 email.value=originalData.email;
 facebook.value=originalData.facebook;
 instagram.value=originalData.instagram;
 youtube.value=originalData.youtube;

 originalData.offers.forEach(o=>{
  addOffer(o.title,o.desc,o.image);
 });
}

function addOffer(t="",d="",img=""){
 const div=document.createElement("div");
 div.innerHTML=`
  <input placeholder="Title" value="${t}">
  <textarea placeholder="Description">${d}</textarea>
  <input type="file">
 `;
 offers.appendChild(div);
 div.dataset.img=img;
}

function compress(file){
 return new Promise(res=>{
  const img=new Image();
  img.src=URL.createObjectURL(file);
  img.onload=()=>{
   const c=document.createElement("canvas");
   c.width=200;c.height=200;
   c.getContext("2d").drawImage(img,0,0,200,200);
   res(c.toDataURL("image/jpeg",0.6));
  }
 });
}

async function save(){

 let profile=originalData.profileImage;
 if(profileImage.files[0]){
  profile=await compress(profileImage.files[0]);
 }

 const offerArr=[];
 for(let o of offers.children){
  let img=o.dataset.img||"";
  if(o.children[2].files[0]){
   img=await compress(o.children[2].files[0]);
  }
  offerArr.push({
   title:o.children[0].value,
   desc:o.children[1].value,
   image:img
  });
 }

 const newData={
  name:name.value,
  businessName:businessName.value,
  businessInfo:businessInfo.value,
  address:address.value,
  phone:phone.value,
  email:email.value,
  facebook:facebook.value,
  instagram:instagram.value,
  youtube:youtube.value,
  profileImage:profile,
  offers:offerArr
 };

 await supabase
  .from("cards")
  .update({data:JSON.stringify(newData)})
  .eq("id",id);

 alert("Updated Successfully");
 location.href="card.html?id="+id;
}
</script>

<script>
if("serviceWorker" in navigator){
 navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
