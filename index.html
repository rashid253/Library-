<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Business Card Generator</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9}
.form-container{max-width:450px;margin:auto;background:white;padding:20px;border-radius:14px;margin-top:30px}
input,textarea,select,button{width:100%;padding:10px;margin:6px 0}
button{background:#2563eb;color:white;border:none;border-radius:8px}
.offerBox{border:1px solid #cbd5f5;padding:10px;border-radius:8px;margin-bottom:8px}
</style>
</head>

<body>

<div class="form-container">
<h2>Create Business Card</h2>

<input id="name" placeholder="Full Name" required>
<input id="businessName" placeholder="Business Name" required>
<textarea id="businessInfo" placeholder="Business Info" required></textarea>
<input id="address" placeholder="Address" required>

<select id="countryCode">
<option value="+92">+92</option>
<option value="+1">+1</option>
<option value="+44">+44</option>
</select>

<input id="phone" placeholder="Phone" required>
<input id="email" placeholder="Email" required>
<input id="facebook" placeholder="Facebook">
<input id="instagram" placeholder="Instagram">
<input id="youtube" placeholder="YouTube">

<label>Profile Photo</label>
<input type="file" id="profileImage" accept="image/*">

<h3>Offers</h3>
<div id="offers"></div>
<button type="button" onclick="addOffer()">Add Offer</button>

<br><br>
<button type="button" onclick="generate()">Generate Card</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
const db = window.supabase.createClient(
 'https://dfvnefbxgayxqgjjgtrr.supabase.co',
 'sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE'
);

function addOffer(){
 const d=document.createElement("div");
 d.className="offerBox";
 d.innerHTML=`
  <input placeholder="Offer Title">
  <textarea placeholder="Description"></textarea>
  <input type="file" accept="image/*">
 `;
 offers.appendChild(d);
}

function compress(file){
 return new Promise(res=>{
  const img=new Image();
  img.src=URL.createObjectURL(file);
  img.onload=()=>{
   const c=document.createElement("canvas");
   c.width=200;
   c.height=200;
   c.getContext("2d").drawImage(img,0,0,200,200);
   res(c.toDataURL("image/jpeg",0.6));
  }
 });
}

async function generate(){

 const n=name.value.trim();
 const b=businessName.value.trim();
 const info=businessInfo.value.trim();
 const addr=address.value.trim();
 const ph=phone.value.trim();
 const em=email.value.trim();

 if(!n||!b||!info||!addr||!ph||!em){
  alert("Please fill all required fields");
  return;
 }

 const id=Math.random().toString(36).substring(2,8);

 const profile = profileImage.files[0]
  ? await compress(profileImage.files[0])
  : "";

 const offerArr=[];
 for(let o of offers.children){
  const img=o.children[2].files[0]
   ? await compress(o.children[2].files[0])
   : "";
  offerArr.push({
   title:o.children[0].value.trim(),
   desc:o.children[1].value.trim(),
   image:img
  });
 }

 const data={
  name:n,
  businessName:b,
  businessInfo:info,
  address:addr,
  phone:countryCode.value+ph,
  email:em,
  facebook:facebook.value.trim(),
  instagram:instagram.value.trim(),
  youtube:youtube.value.trim(),
  profileImage:profile,
  offers:offerArr
 };

 await db.from("cards").insert({
  id:id,
  data:JSON.stringify(data)
 });

 location.href="card.html?id="+id;
}
</script>

<script>
if("serviceWorker" in navigator){
 navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
